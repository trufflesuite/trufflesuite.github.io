<!DOCTYPE html>
<html>
<head>
  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-WHT4PS2');</script>
  <!-- End Google Tag Manager -->
  
  <!-- HubSpot Forms -->
  <!--[if lte IE 8]>
    <script charset="utf-8" type="text/javascript" src="//js.hsforms.net/forms/v2-legacy.js"></script>
  <![endif]-->
  <script charset="utf-8" type="text/javascript" src="//js.hsforms.net/forms/v2.js"></script>  <!-- Start of HubSpot Embed Code -->
  <script type="text/javascript" id="hs-script-loader" async defer src="//js.hs-scripts.com/5258293.js"></script>
  <!-- End of HubSpot Embed Code -->  
  <meta charset="utf-8">
  <meta name="description" content="The Truffle suite of tools make dapp development easier and more consistent.">
  
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    
  <!-- Favicon -->
  <link rel="icon" href="/img/favicons/favicon.ico">

  <!-- Add to homescreen for Chrome on Android -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="application-name" content="Truffle Suite">
  <link rel="icon" sizes="192x192" href="/img/favicons/chrome-touch-icon-192x192.png">

  <!-- Add to homescreen for Safari on iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="Truffle Suite">
  <link rel="apple-touch-icon" href="/img/favicons/apple-touch-icon.png">

  <!-- Tile icon for Win8/10 (144x144 + tile color) -->
  <meta name="msapplication-TileImage" content="img/favicons/ms-touch-icon-144x144-precomposed.png">
  <meta name="msapplication-TileColor" content="#3372DF">

  <!-- Facebook OpenGraph -->
  <meta property="og:site_name" content="Truffle Suite" />
  <meta property="og:description" content="The Truffle suite of tools make dapp development easier and more consistent." />
  <meta property="og:title" content="Axoni&#x27;s Enterprise Use of Truffle | Blog | Truffle Suite" />
  <meta property="og:url" content="https://trufflesuite.com/blog/axonis-enterprise-use-of-truffle" />
  <meta property="og:type" content="article" />
  <meta property="og:image" content="https://truffleframework.com/img/favicons/truffle-share.png" />

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="Truffle Suite" />
  <meta name="twitter:title" content="Axoni&#x27;s Enterprise Use of Truffle | Blog | Truffle Suite" />
  <meta name="twitter:description" content="The Truffle suite of tools make dapp development easier and more consistent." />
  <meta name="twitter:creator" content="Truffle Suite" />
  <meta name="twitter:domain" content="trufflesuite.com" />
  <meta name="twitter:image:src" content="https://truffleframework.com/img/favicons/truffle-share.png" />
  
  <meta name="google-site-verification" content="BSgPkMHzw7IxJTpEElNfD8ZZYPzXgOQiTVPzAxAG8-o" />
    
  <title>Axoni&#x27;s Enterprise Use of Truffle | Blog | Truffle Suite</title>

  <link href="https://fonts.googleapis.com/css?family=Grand+Hotel|Open+Sans|Oswald|Varela+Round|Roboto+Condensed|Roboto+Mono" rel="stylesheet">
  <script src="https://kit.fontawesome.com/371f2d7a8a.js" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="/css/index.css">
</head>
<body>
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-WHT4PS2"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->  
  <nav class="navbar navbar-expand-md navbar-dark fixed-top" id="primaryNav">
    <a class="navbar-brand current" href="/">
      <img class="suite-logo" src="/img/truffle-logomark.svg" alt="Truffle Logo" /><span class="d-none d-lg-block">TRUFFLE SUITE</span>
    </a>
  
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarsExampleDefault" aria-controls="navbarsExampleDefault" aria-expanded="false" aria-label="Toggle navigation">
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </button>
  
    <div class="collapse navbar-collapse" id="navbarsExampleDefault">
      <ul class="navbar-nav ml-auto">
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" id="suiteDropdown" href="#" data-toggle="dropdown">SUITE</a>
  
          <div class="dropdown-menu">
            <a class="text-truffle" href="/teams">
              <img class="suite-logo" src="/img/tt-logomark.svg" alt="Truffle Teams Logo" /><span class="narrow">T</span>RUFFLE TEAMS
            </a>
            <a class="text-truffle" href="/truffle">
              <img class="suite-logo" src="/img/truffle-logomark.svg" alt="Truffle Logo" /><span class="narrow">T</span>RUFFLE
            </a>
            <a class="text-ganache" href="/ganache">
              <img class="suite-logo" src="/img/ganache-logomark.svg" alt="Ganache Logo" />Ganache
            </a>
            <a class="text-drizzle" href="/drizzle">
              <img class="suite-logo" src="/img/drizzle-logomark.svg" alt="Drizzle Logo" />dri<span class="drizzle-z-skew-1">z</span><span class="drizzle-z-skew-2">z</span>le
            </a>
          </div>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/docs">DOCS</a>
        </li>
        <li class="nav-item">
          <a class="nav-link trufflecon-link" href="/trufflecon2020">TRUFFLEC<img src="/img/truffle-logomark.svg" alt="Truffle Logo"/>N</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/tutorials">TUTORIALS</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/boxes">BOXES</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/blog">BLOG</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/events">EVENTS</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/community">COMMUNITY</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/university">UNIVERSITY</a>
        </li>
      </ul>
    </div>
  </nav>
  <main class="container container-heading container-narrow">
    <div class="row">
      <div class="col">
        <h1>Axoni&#x27;s Enterprise Use of Truffle</h1>
        <ul class="list-sm-stacker space-icon mb-0">
          <li><i class="far fa-calendar-alt"></i> 2019-7-25&nbsp;&nbsp;&nbsp;</li>
          <li><i class="far fa-user"></i> Jonathan Leslie, Guest Blogger, a Lead Software Engineer from Axoni</li>
        </ul>
      </div>
    </div>
  </main>

  <main class="banner banner-light-cream pt-5 pb-5" role="main">
    <div class="container container-post">
      <div class="row justify-content-center">
        <div class="col">
          <p>
    <img class="img-fluid" src="/img/blog/axonis-enterprise-use-of-truffle/truffle-axoni.png" title="Truffle + Axoni" alt="Truffle + Axoni" />
    
  </p>

    <h2 class="link-markdown">
      <a class="anchor-target" name="axoni-background"></a>
      <a href="#axoni-background"><i class="fas fa-link"></i></a>
      Axoni Background
    </h2>
  <p>At Axoni, our mission is to make shared information more trusted and reliable. We do this through distributed technology that we call &quot;Ethereum-inspired&quot;, which has both a broad and a specific meaning. In the broad sense, the core technology plays a role for its users analogous to the public blockchain, presenting a powerful and extensible capacity to side-step undesired intermediaries (yes, these exist for banks too...). In a more precise technical sense, our platform borrows certain concepts from Ethereum (e.g. accounts, contracts, gas...) and, importantly, we make efforts to comply with Ethereum-world interfaces (e.g. evm bytecode, web3 JSON-rpc).</p>
<p>Of course, an up-shot of the last is the ability to take part in all the innovation taking place in the broader Ethereum ecosystem, including client-side libraries that enable a &quot;tastier&quot; application development process. To this end, within the last year we have worked to leverage the Truffle suite and ecosystem to great effect. In fact, as <a href="https://www.forbes.com/sites/michaeldelcastillo/2019/04/29/consensys-spins-off-ethereum-startup-truffle-to-take-blockchain-to-big-business/#1e84a5622e21">reported</a>, it is fair to say that Truffle serves by and large as the main toolset for on-chain application development at Axoni.</p>

    <h2 class="link-markdown">
      <a class="anchor-target" name="using-truffle-at-axoni"></a>
      <a href="#using-truffle-at-axoni"><i class="fas fa-link"></i></a>
      Using Truffle at Axoni
    </h2>
  <p>It was a delight for us to find that, given our compliance with the web3 JSON-RPC spec, truffle basically works &quot;out-of-the-box&quot; with no extensive customization required for many very useful stages in the application lifecycle: develop, build, test....</p>
<p>One notable exception: we found the native <code>truffle migrate</code> functionality not extensible to our use case. In part, this is due to the fact that our smart contract applications implement something <a href="https://blog.zeppelinos.org/the-transparent-proxy-pattern/">similar to the proxy pattern</a>, which runs counter to the &quot;migration&quot; paradigm. On the other hand, and for reasons beyond the scope of this post, tools such as <code>zoslib</code> designed to handle upgradeable smart contract application deployments, generate smart contract implementations incompatible with our use case. At a high level, our smart contract framework is optimized for high-throughput and highly complex Solidity applications which enables the ability to make automatic upgrades based on semantic versioning. [ Note: I plan to speak more about our particular use cases and smart contract topologies at Trufflecon on August 3rd]</p>
<p>In any case, especially due to the often very high levels of complexity entailed by our use cases– combined with the noted <a href="https://blog.trailofbits.com/2018/09/05/contract-upgrade-anti-patterns/">application-level gotcha&#39;s of upgrade design patterns in solidity itself</a>–we are biased towards a simple and opinionated declarative format that application and production engineers can easily understand and (when needed) manipulate.</p>
<p>This raises the question -- why use truffle for this? It seems there are at least three reasons:</p>
<ol>
<li><code>truffle-config.js</code> / <code>truffle.js</code> serves as an already existing central source of shared information about various network providers relevant for a particular application developer. It only makes sense to extend this format for use in production-like environments as well.</li>
<li>Truffle code artifacts, a battle-tested standard for smart contracts and solidity code, in particular, provide a common interface for a toolchain. By virtue of using truffle, there is no need to re-create this format. For a non-development deployment, a <code>contracts_build_directory</code> parameter is supplied, which results in a pull from a remote artifacts repository.</li>
<li>Obviously <code>@truffle/contract</code> itself provides a nice object oriented interface for deploying and performing operations on contracts within this script, thus avoiding any reinventing the wheel within the deployment library itself.</li>
</ol>
<p>Thus, we ventured to build a package on top of truffle that manages configuration-driven smart contract deployments and upgrades.</p>

    <h2 class="link-markdown">
      <a class="anchor-target" name="building-a-truffle-based-deployment-tool"></a>
      <a href="#building-a-truffle-based-deployment-tool"><i class="fas fa-link"></i></a>
      Building a Truffle-Based Deployment Tool
    </h2>
  <p>The first question is what the configuration file should look like? We determined the &quot;Straw Man&quot; to be, simply, a two-dimensional list of job types and associated contracts specified for deployment. Starting with this, we found another concept we needed to add (&quot;custom-partition&quot;) that is specific to Axcore, relating to the way the node software provisions data across network partitions; certain contracts are provisioned differently from others. In addition to this, we found that the only other concept we needed was a parameter specifying dependencies (&quot;deps&quot;) that linearizes to a certain order to deployment (which may be necessary, for instance, if a given storage address stores reference to another). For concision, we added limited regex support. In the end, we arrived at a yaml-based file looking very much like the below:</p>
<pre><code class="language-yaml">version: 0.0.1
setup:
    partitions:
        - custom-partition: *
        - custom-partition: ^public-common
    contracts:
        - name: MagmaRegistryFooStorage
        - name: MagmaRegistryBarStorage
          deps:
            - MagmaRegistryFooStorage
upgrade:
    partitions:
        - custom-partition: &quot;*&quot;
    contracts:
        - name: MagmaRegistryFoo
        - name: MagmaRegistryBar</code></pre>
<p>In terms of implementation, a truffle exec script reads this configuration file, and for each contract, a) deploys the contract b) performs some basic API configuration and c) installs it in the application through invoking a basic <code>initialization</code> method. The basic top-level run (truffle exec) script looks very much like the below:</p>
<pre><code class="language-javascript">const run = async (done) =&gt; {
    let jobParams = args;

        // Configure specific variables for a PROD-like environment:
    if (process.env.ENV === &#39;PROD&#39;) {
        jobParams = Object.assign(args, handleProd());
    }

       //hoisting injected vars to global scope:
    global.web3 = web3;
    global.artifacts = artifacts;

        // Create instance of job based on type
    const jobInstance = new Job(jobParams.job, jobParams);

        //Run job by deploying and invoking an initialization method on each contract
    await jobInstance.run().catch(e =&gt; done(e));
    done();
};</code></pre>
<p>A command-line client can specify a given job to run, such as the &quot;upgrade&quot; job specified above. Given the above configuration, the below command would deploy (if necessary) and initialize &quot;MagmaRegistryFooStorage&quot;, followed by &quot;MagmaRegistryBarStorage&quot; from a given artifacts repository:</p>
<pre><code class="language-bash">etna --job upgrade --contracts_build_directory /path/to/artifacts</code></pre>

    <h2 class="link-markdown">
      <a class="anchor-target" name="future-plans-and-an-announcement"></a>
      <a href="#future-plans-and-an-announcement"><i class="fas fa-link"></i></a>
      Future Plans and an Announcement
    </h2>
  <p>I am pleased to announce that we plan to open-source our core Solidity smart contract library, which provides an alternative version of the Proxy pattern, along with this aforementioned deployment tool. We believe both could be useful both for private and public applications and the Axoni team is excited to see what the community builds with these tools.</p>
<p>In the meantime, we hope the above at least provides a high-level example of an approach to building lightweight extensions within truffle, and as a simplifying approach to the smart contract deployment process, especially for Proxy Pattern topologies.</p>
<p>The Axoni team and I look forward to discussing this topic and much more (such as <a href="https://axoni.com/axlang/">Axlang, our Scala-based Solidity-alternative</a>) at Trufflecon.</p>


          <div class="contribute-link">
            See a way to make this page better? <a href="https://github.com/trufflesuite/trufflesuite.com/edit/develop/src/blog">Edit here &raquo;</a>
          </div>        </div>
      </div>
    </div>
  </main>

  <footer>
    <div class="container">
      <div class="row">
        <div class="col-12 col-md-2 mb-4 mb-md-0">
          <img class="truffle-logo" src="/img/truffle-logo-light.svg" alt="Truffle Logo" />
        </div>
  
        <div class="col-12 col-md-5 mb-3 mb-md-0">
          <ul>
            <li><a href="mailto:inquiry@trufflesuite.com">CONTACT US</a></li>
            <li><a href="/policy">PRIVACY POLICY</a></li>
            <li><a href="/press-releases">PRESS RELEASES</a></li>
            <li><a href="/staff">STAFF</a></li>
            <li><a href="/dashboard">DASHBOARD</a></li>
            <li><a href="https://github.com/trufflesuite">GITHUB</a></li>
            <li><a class="trufflecon-link" href="https://www.trufflesuite.com/trufflecon2020">TRUFFLEC<img src="/img/truffle-logomark.svg" alt="Truffle Logo" /><span>O</span>N 2020</a></li>
            <li><strong>&copy; Truffle Blockchain Group 2020</strong></li>
          </ul>
  
          <ul class="list-inline h4 ">
            <li class="list-inline-item mb-0"><a href="https://www.reddit.com/r/truffle"><i class="fab fa-reddit-square"></i></a></li>
            <li class="list-inline-item mb-0"><a href="https://twitter.com/trufflesuite"><i class="fab fa-twitter-square"></i></a></li>
            <li class="list-inline-item mb-0"><a href="https://www.facebook.com/trufflesuite/"><i class="fab fa-facebook-square"></i></a></li>
            <li class="list-inline-item mb-0"><a href="https://www.instagram.com/truffledevsuite/"><i class="fab fa-instagram"></i></a></li>
            <li class="list-inline-item mb-0"><a href="https://www.linkedin.com/company/trufflesuite/"><i class="fab fa-linkedin"></i></a></li>
            <li class="list-inline-item mb-0"><a href="https://www.youtube.com/channel/UCo2cy2Z7_91zPJSrb6NWfSw"><i class="fab fa-youtube-square"></i></a></li>
          </ul>
        </div>
  
        <div class="col-12 col-md-5">
          <h4>SIGN UP FOR THE TRUFFLE MAILING LIST</h4>
          <script>
            hbspt.forms.create({
               portalId: "5258293",
               formId: "afcfabf3-e2c3-4a08-aace-ef5c7b13c3d8"
            });
          </script>
        </div>
      </div>
    </div>
  </footer>
  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
  <script>window.jQuery || document.write('<script src="/js/vendor/jquery-3.2.1.slim.min.js"><\/script>')</script>
  <script src="/js/bootstrap.min.js"></script>
  <script src="/js/vendor/prism.js"></script>
  <script src="/js/markdown-cleanup.js"></script>
</body>
</html>